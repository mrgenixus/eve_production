

= form_for [build_plan, build_plan.planned_items.build], html: { class: 'form-inline'} do |f|
  %h3 Plan Item
  .product.form-group
    = f.label :product
    = f.select :item_id, Produceable.all.map { |produceable| [ produceable.name, produceable.id] }
  .qty.form-group
    = f.label :qty
    = f.number_field :qty
  .submit.form-group
    = f.submit class: 'btn btn-primary'


%table.table.table-condensed.table-striped
  %tr
    %th qty
    %th Name
    %th Item Cost
    %th Item Value
    %th Aggregate Cost
    %th Aggregate Projected Value
    %th

  - build_plan.planned_items.preload(:product).each do |planned_item|
    - if planned_item.product
      %tr
        %td= link_to planned_item.qty, edit_planned_item_path(planned_item)
        %td= link_to planned_item.product.name, edit_produceable_path(planned_item.product)
        %td
          = link_to produceable_path(planned_item.product) do
            = number_to_currency planned_item.product.cost

        %td
          = link_to edit_produceable_path(planned_item.product) do
            = number_to_currency planned_item.product.value

        %td= number_to_currency planned_item.cost
        %td= number_to_currency planned_item.value

        %td= link_to 'Delete', planned_item_path(planned_item), method: :delete

= form_for [build_plan, build_plan.plan_inventory_items.build], html: { class: 'form-inline'} do |f|
  %h3 Plan Inventory Item
  .product.form-group
    = f.label :product
    = f.select :item_id, Produceable.all.map { |produceable| [ produceable.name, produceable.id] }
  .qty.form-group
    = f.label :qty
    = f.number_field :qty
  .submit.form-group
    = f.submit class: 'btn btn-primary'


%table.table.table-condensed.table-striped
  %tr
    %th qty
    %th Name
    %th Item Cost
    %th Item Value
    %th Aggregate Cost
    %th Aggregate Projected Value
    %th

  - build_plan.plan_inventory_items.each do |plan_inventory_item|
    - if plan_inventory_item.component
      %tr
        %td
          = link_to edit_plan_inventory_item_path(plan_inventory_item) do
            = plan_inventory_item.qty
        %td= link_to plan_inventory_item.component.name, edit_produceable_path(plan_inventory_item.component)

        %td
          =link_to produceable_path(plan_inventory_item.component) do
            = number_to_currency plan_inventory_item.component.cost

        %td
          = link_to edit_produceable_path(plan_inventory_item.component) do
            = number_to_currency plan_inventory_item.component.value

        %td= number_to_currency plan_inventory_item.cost
        %td= number_to_currency plan_inventory_item.value

        %td= link_to 'Delete', plan_inventory_item_path(plan_inventory_item), method: :delete

%h3 Purchase Order
%table.table.table-condensed.table-striped
  %tr
    %th Name
    %th Qty
    %th Cost
    %th Agg. Value
    %th Unit Price
    %th
    %th

  - build_plan.purchase_order.each do |orderable|
    %tr
      %td= orderable.produceable.name
      %td= number_with_delimiter orderable.qty
      %td= number_to_currency orderable.cost
      %td
        #{number_to_currency orderable.value}
        - if orderable.value > orderable.cost
          %span.text-danger
            = number_to_currency orderable.value - orderable.cost
        - elsif orderable.value < orderable.cost
          %span.text-success
            = number_to_currency orderable.cost - orderable.value

      %td
        = link_to edit_produceable_path(orderable.produceable) do
          = number_to_currency (orderable.produceable.value || orderable.produceable.cost)

      %td #{number_with_precision (orderable.cost / build_plan.cost) * 100, precision: 2}%
      %td
        - if orderable.produceable.has_components?
          = link_to "Add To Plan", build_plan_planned_items_path(@build_plan, planned_item: {item_id: orderable.produceable.id, qty: orderable.qty}), method: :post
        = link_to "Add To Inventory", build_plan_plan_inventory_items_path(@build_plan, plan_inventory_item: {item_id: orderable.produceable.id, qty: orderable.qty}), method: :post
  %tr
    %td{colspan: 2}
    %td= number_to_currency build_plan.purchase_order.cost

